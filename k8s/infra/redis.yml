apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
data:
  redis.conf: |
    bind 0.0.0.0
    port 6379
    protected-mode no
    dir /data
  sentinel.conf: |
    port 26379
    dir /tmp
    sentinel resolve-hostnames yes
    sentinel monitor mymaster redis-0.redis-headless.omnimfa.svc.cluster.local 6379 2
    sentinel down-after-milliseconds mymaster 3000
    sentinel failover-timeout mymaster 6000
    sentinel parallel-syncs mymaster 1
---
apiVersion: v1
kind: Service
metadata:
  name: redis-headless
spec:
  clusterIP: None
  ports:
    - name: redis
      port: 6379
  selector:
    app: redis
---
# Redis StatefulSet (Master + Slaves)
# Note: For simple local setup, we start master (redis-0) and slaves(redis-1,2) manually or via script,
# but for simplicity here we rely on the fact that redis-0 is usually master.
# A proper HA setup needs init containers to determine master, but for local dev this is sufficient.
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
spec:
  serviceName: "redis-headless"
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:latest
          command: ["bash", "-c"]
          args:
            - |
              # ordinal index from hostname
              ORDINAL=${HOSTNAME##*-}
              if [ $ORDINAL -eq 0 ]; then
                echo "I am Master"
                redis-server /etc/redis/redis.conf
              else
                echo "I am Slave of redis-0"
                redis-server /etc/redis/redis.conf --replicaof redis-0.redis-headless.omnimfa.svc.cluster.local 6379
              fi
          ports:
            - containerPort: 6379
          volumeMounts:
            - name: config
              mountPath: /etc/redis/
            - name: data
              mountPath: /data
      volumes:
        - name: config
          configMap:
            name: redis-config
            items:
              - key: redis.conf
                path: redis.conf
        - name: data
          emptyDir: {}
---
# Redis Sentinel Service
apiVersion: v1
kind: Service
metadata:
  name: redis-sentinel
spec:
  ports:
    - port: 26379
      targetPort: 26379
  selector:
    app: redis-sentinel
---
# Redis Sentinel Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-sentinel
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis-sentinel
  template:
    metadata:
      labels:
        app: redis-sentinel
    spec:
      containers:
        - name: sentinel
          image: redis:latest
          command: ["redis-sentinel", "/etc/redis/sentinel.conf"]
          ports:
            - containerPort: 26379
          volumeMounts:
            - name: config
              mountPath: /etc/redis/
      volumes:
        - name: config
          configMap:
            name: redis-config
            items:
              - key: sentinel.conf
                path: sentinel.conf
